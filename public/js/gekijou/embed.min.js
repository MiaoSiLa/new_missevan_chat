/*! app_missevan_chat 2015-08-10 by tengattack */
var ContactList,DScrollbar,GekijouEmbed;console.log("gekijou embed"),DScrollbar=function(){function a(){}return a.prototype.update=function(a){var b,c,d,e,f,g,h,i;c=a.parents(".scroll-wrapper"),b=c.find(".scroll-content"),b.length<=0||(d=b.height(),f=a.height(),e=b.find("div").height(),i=parseInt(a.css("top").replace("px","")),g=i/(d-f),h=(e-d)*g,b[0].scrollTop=h)},a.prototype.init=function(){var a,b,c;c=$(".scroll-wrapper"),c&&c.length&&(c.find(".scroll-content").scroll(function(){var a,b,c,d,e,f,g;a=$(this),b=a.parent().find(".scroll-bar"),b.hasClass("draggable")||(c=a.height(),e=b.height(),d=a.find("div").height(),f=this.scrollTop/(d-c),g=(c-e)*f,b.css("top",g))}),a=c.find(".scroll-bar"),a.draggable&&(a.draggable({axis:"y",cursor:"default",containParent:!0}),b=this,a.mousemove(function(a){0===a.button&&1===a.buttons&&b.update($(this))})),a.parent().click(function(a){var b,c,d,e,f,g,h,i,j,k;if(e=$(this),d=e.parents(".scroll-wrapper"),b=d.find(".scroll-content"),c=e.find(".scroll-bar"),!(b.length<=0)){if(f=b.height(),h=c.height(),g=b.find("div").height(),k=parseInt(c.css("top").replace("px","")),i=a.offsetY,k>i)j=b[0].scrollTop-50;else{if(!(i>k+h))return;j=b[0].scrollTop+50}0>j?j=0:j>g-f&&(j=g-f),b[0].scrollTop=j}}))},a}(),ContactList=function(){function a(){}return a.prototype.init=function(){var a,b;a=$(".contact_list"),a&&a.length&&(this.init_state(),b=this,a.find(".contact_item").click(function(){var a,c;a=$(this).data("actorid"),c="/theatre/api/actor?id="+a,$.ajax({url:c,dataType:"json",success:function(a){a&&"success"===a.state&&b.load(a)}})}))},a.prototype.init_state=function(){var a;this.pushState=window.history&&window.history.pushState,this.pushState&&(a=this,window.onpopstate=function(b){b.state&&b.state.actor?a.load(b.state.actor,!0):window.location.reload()})},a.prototype.update_url=function(a,b){this.pushState&&(a?window.history.pushState({actor:b},"","/theatre/actor/profile?actorid="+a):window.history.pushState({actor:b},"","/theatre/actor"))},a.prototype.load=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;if(g=$(".box .box_bd"),h=g.find(".empty"),l=g.find(".profile"),f=null,a&&a.info){if(k=a.info,f=k.id,l.find(".nickname").text(k.name),l.find(".signature").text(k.signature),l.find("#profile-intro .detail").text(k.intro?k.intro:"还没有填写"),l.find(".avatar img").attr("src",k.avatar_url),d=l.find(".profile_more_avatars"),a.avatars&&a.avatars.length){for(j="\n",s=a.avatars,o=0,q=s.length;q>o;o++)e=s[o],j+='<img class="img lazy" src="'+e.avatar_url+'" />\n';j+='<img class="img lazy img-first" src="'+k.avatar_url+'" style="display:none" />',d.html(j),d.show(),d.find("img").click(function(){var a,b;b=$(this),b.parent().find(".img-first").show(),a=b.parents(".profile"),a.find(".avatar img").attr("src",b.attr("src"))})}else d.html(""),d.hide();if(i=a.scripts?a.scripts.length:0,n=a.shares?a.shares.length:0,c=l.find(".profile_analytics span strong"),$(c[0]).text(i.toString()),$(c[1]).text(n.toString()),l.find("#profile-gekijou a").attr("href","/theatre/actor/scripts?actorid="+k.id),l.find("#profile-shares a").attr("href","/theatre/actor/space?actorid="+k.id),l.find("#profile-shares .detail").text(n>0?"共 "+n+" 条":"还没有朋友圈"),i){for(j="\n",t=a.scripts,p=0,r=t.length;r>p;p++)m=t[p],j+='<img class="profile_script_img" src="'+m.cover_url+'" />\n';l.find("#profile-gekijou .detail").html(j)}else l.find("#profile-gekijou .detail").text("还没有演过剧本");h.hide(),l.show()}else l.hide(),h.show();b||this.update_url(f,a)},a}(),GekijouEmbed=function(){function a(){}return a.prototype.load=function(a){var b,c,d;d=$("#share_box"),b=$("#chat_box"),d.hasClass("box_active")||(a?(d.addClass("box_active"),b.find(".box_bd").html('<iframe class="gekijou-embed" src="/gekijou/view/'+a+'"></iframe>'),c=b.find("iframe"),c.load(function(){d.hide().removeClass("box_active"),b.show(),c.focus()})):(b.find(".box_bd").html(""),b.hide(),d.show()))},a.prototype.back=function(){return this.load(!1)},a.prototype.insertcss=function(){var a,b;a=".gekijou-embed {\n  width: 100%;\n  height: 100%;\n  border: none;\n}\n#chat_box .box_bd {\n  overflow: hidden;\n}",b=document.createElement("style"),b.type="text/css","string"==typeof b.textContent?b.textContent=a:b.styleSheet.cssText=a,$("head").append(b)},a.prototype.init=function(){var a,b,c,d;d=$("#share_box"),d&&d.length&&(c=this,this.insertcss(),a=$("#chat_box .back"),a.click(function(){c.back()}),b=$(".content_chat"),b.click(function(){var a;return a=$(this).data("chatid"),c.load(a),!1}))},a}(),$(document).ready(function(){var a,b,c;c=new GekijouEmbed,b=new DScrollbar,a=new ContactList,c.init(),b.init(),a.init()});