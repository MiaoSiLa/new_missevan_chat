/*! app_missevan_chat 2015-08-13 by tengattack */
var GekijouEditor;GekijouEditor=function(){function a(a,b){this.gekijou=a,this.mode=null!=b?b:"default",this.eb=new Editorbar($("#inputbox"),this),this.af=new ActionForm,GG.editor=this}return a.prototype.init=function(a){var b;b=this,this.eb.bind(),this.af.bind(),this._id=this.eb.getId(),this.gekijou.setOptions({env:"dev"}),"simple"===this.mode&&this.gekijou.setOptions({editormode:"simple"}),this.gekijou.init(function(){b.gekijou.preload(),chatBox.addInfo("我是M娘","欢迎使用小剧场编辑器"),null!=a&&a()})},a.prototype.generate=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;for(d=this.gekijou.chara,g=this.gekijou.em,b=this.gekijou.album,h="",h="setup {\n",b.albums&&b.albums.length&&(h+="  album "+b.albums.join()+"\n"),this.gekijou.opts.showname===!1&&(h+="  showname off\n"),this.gekijou.opts.instantshow===!0&&(h+="  instantshow on\n"),"simple"===this.gekijou.opts.editormode&&(h+="  editormode simple\n"),h+="}\n\n",h+="chara {\n",o=d.charas,i=0,l=o.length;l>i;i++)c=o[i],h+="  define "+c.id+" "+JSON.stringify(c.username)+" {\n",h+="    actor "+c.iconid+"\n",h+="    icon "+JSON.stringify(c.iconurl),c.iconcolor&&(h+=" "+JSON.stringify(c.iconcolor)),h+="\n",c.subtitle&&(h+="    subtitle "+JSON.stringify(c.subtitle)+"\n"),"right"===c.showon&&(h+="    showon right\n"),h+="  }\n";for(h+="}\n\n",h+="event {\n",p=g.events,j=0,m=p.length;m>j;j++){for(f=p[j],h+="  define "+f.id+" "+JSON.stringify(f.name)+" "+JSON.stringify(f.time)+" {\n",q=f.actions,k=0,n=q.length;n>k;k++){switch(a=q[k],-1===a.chara&&"image"===a.type&&(a.type="state",a.stype="image"),h+="    "+a.type+" ",a.type){case"background":h+='"'+a.effect+'" '+JSON.stringify(a.val);break;case"state":"text"===a.stype?(e=-1===a.chara?"nochara":"chara:"+a.chara,h+="text "+e+" "):h+="image ",h+=JSON.stringify(a.val);break;case"sound":e=-1===a.chara?a.stype:"chara:"+a.chara,h+=""+e+" "+JSON.stringify(a.val);break;default:e=-1===a.chara?"nochara":"chara:"+a.chara,h+=""+e+" "+JSON.stringify(a.val)}h+="\n"}h+="  }\n"}return h+="}\n"},a.prototype.setId=function(a){this._id=a,this.eb.setId(this._id)},a.prototype["delete"]=function(a){var b,c;b=this,c={_id:this._id},moTool.postAjax({url:"/gekijou/delete",value:c,callBack:function(b){var c;c=!1,b&&(c=0===b.code),c?moTool.showError("删除成功"):b.message?moTool.showError(b.message):moTool.showError("删除失败"),null!=a&&a(c)},showLoad:!0,success:!1,error:!1,json:!1})},a.prototype.save=function(a,b,c){var d,e;d=this,e={title:a,intro:b,script:this.generate()},this._id&&(e._id=this._id),moTool.postAjax({url:"/gekijou/save",value:e,callBack:function(a){var b;b=null,a&&(0===a.code?(b=a.gekijou,b&&b._id&&d.setId(b._id)):a.message?moTool.showError(a.message):moTool.showError("未知错误")),null!=c&&c(b)},showLoad:!0,success:!1,error:!1,json:!1})},a}();