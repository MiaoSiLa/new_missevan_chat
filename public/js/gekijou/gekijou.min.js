/*! app_missevan_chat 2015-08-13 by tengattack */
var ActionForm,ControlBar,Editorbar,GGManager,ImageTools,Paginationbar,Playbar,Toolbar,Util,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Util=function(){function a(){}return a.prototype.init=function(){String.prototype.trim||(String.prototype.trim=function(){return $.trim(this)})},a.prototype.escape=function(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},a.prototype.unescape=function(a){return a.replace(/&(#0?34|quot);/g,'"').replace(/&#0?39;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")},a.prototype.findquoteend=function(a,b){var c,d,e,f;for(d=-1,e=b,f=a.length,c='"'===a[e],e++;f>e;)if("\\"===a[e])switch(e++,a[e]){case"u":e+=5;break;case"x":e+=3;break;default:e++}else{if(c&&'"'===a[e]||!c&&"'"===a[e]){d=e;break}e++}return d},a.prototype.findblockend=function(a,b){var c,d,e;for(c=-1,d=b,e=a.length;e>d;){if("'"===a[d]||'"'===a[d]){if(d=this.findquoteend(a,d),-1===d)break}else if("{"===a[d]){if(d=this.findblockend(a,d+1),-1===d)break}else if("}"===a[d]){c=d;break}d++}return c},a.prototype.splitblock=function(a){var b,c,d,e,f,g;for(b=[],d=0;;){if(e=a.indexOf("{",d),!(e>=0))break;if(g=a.substring(d,e),e++,f=this.findblockend(a,e),!(f>=0))break;c=a.substring(e,f),b.push({title:g.trim(),content:c}),d=f+1}return b},a.prototype.splitprop=function(a){var b,c,d,e,f,g;if(g=[],a=a.trim())for(d=0,e=-1,f=a.length,b=/\s/;f>d;){if('"'===a[d]||"'"===a[d]){if(e=this.findquoteend(a,d),-1===e)break;e++}else{if(b.test(a[d])){d++;continue}for(e=d+1,c=!1;f>e;){if(b.test(a[e])){c=!0;break}e++}}g.push(a.substring(d,e)),d=e}return g},a.prototype.splitline=function(a){var b,c,d,e,f,g;for(d=[],g=a.split("\n"),e=0,f=g.length;f>e;e++)c=g[e],b=c.trim(),b&&d.push(b);return d},a.prototype.splitsubcommand=function(a,b){var c,d,e,f,g,h,i,j,k;g={sound:{chara:["chara","角色","人物"],effect:["effect","音效"],background:["background","bgm","背景乐"]}};for(c in g)if(e=g[c],a===c){i=b;for(h in e)for(d=e[h],j=0,k=d.length;k>j;j++)if(f=d[j],i.substr(0,f.length).toLowerCase()===f)return b=i.substr(0+f.length).trim(),[a,h,b]}return[a,b]},a.prototype.splitcommand=function(a){var b,c,d,e,f,g,h,i;if(c={sound:["sound","声音","音频"],album:["album","专辑"],state:["state","状态"]},e=null,"/"===a[0])for(f in c)for(b=c[f],h=0,i=b.length;i>h;h++)if(d=b[h],a.substr(1,d.length).toLowerCase()===d)return g=a.substr(1+d.length).trim(),e=this.splitsubcommand(f,g);return e},a}(),GGManager=function(){function a(){window.GG=this}return a}(),ActionForm=function(){function a(){}return a.prototype.bind=function(){$("form").submit(function(a){return!1})},a}(),ImageTools=function(){function a(){}return a.prototype.callback=function(){moTool.hideModalBox(this.modal),this.result&&0===this.result.code&&this.cb(null,this.type(),this.result.url)},a.prototype.isextend=function(){return $("#inputbox").hasClass("full-editor")},a.prototype.progress=function(a){this.modal.find("#img_upload_progress").text(a)},a.prototype.type=function(){return this.modal.find("input[type=radio]:checked").val()},a.prototype.initImageUpload=function(a){var b,c,d,e,f;return this.cb=a,f=this,b=$("#chattop"),c=b,e=$("#imagemodal"),this.modal=e,e.find("#imageokbtn").click(function(){$(this).hasClass("pending")||f.callback()}),d=$("#imagefile input",c),d.bind("fileuploadprogress",function(a,b){var c,d;c=b.progress(),c.loaded===c.total?f.progress("上传完成，等待响应"):(d=(100*c.loaded/c.total).toFixed(1),f.progress(d+"%"))}),d.fileupload({url:"http://backend1.missevan.cn/mimage/chatimage",dropZone:b,dataType:"json",multipart:!0,add:function(a,b){var c;f.result=null,c=GG.em.current(),c?(f.progress("0%"),e.find("#imageokbtn").addClass("pending"),moTool.showModalBox(e),b.submit().error(function(){f.progress("错误")})):moTool.showError("请先新建一个事件！")},done:function(a,b){var c,d;b&&b.result&&(d=b.result,f.result=b.result,0!==d.code?f.progress("错误"):(f.progress("加载中"),c=new Image,c.onload=function(){return f.progress("完成"),e.find("#imageokbtn").removeClass("pending")},c.src=d.url))}}),$(document).bind("dragover",function(a){var c,d,e,f;for(c=b,f=window.dropZoneTimeout,f?clearTimeout(f):c.addClass("in"),d=!1,e=a.target;e;){if(e===c[0]){d=!0;break}e=e.parentNode}return d?c.addClass("hover"):c.removeClass("hover"),window.dropZoneTimeout=setTimeout(function(){return window.dropZoneTimeout=null,c.removeClass("in hover")},100)}),$("#fileuploadbtn",c).click(function(){return $("#imagefile input",c).click()})},a}(),ControlBar=function(){function a(a){this.el=a}return a.prototype.$=function(a){return this.el.find(a)},a.prototype.bind=function(){},a}(),Paginationbar=function(a){function b(a){this.el=a,b.__super__.constructor.call(this,this.el)}return __extends(b,a),b.prototype.update=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o;if(c=this.el,this.p=a,null!=b?this.pagecount=b:b=this.pagecount,a&&b){if(1===a?c.find(".first, .previous").addClass("hidden"):(c.find(".first").data("page",1),c.find(".previous").data("page",a-1),c.find(".first, .previous").removeClass("hidden")),a>=b?c.find(".next, .last").addClass("hidden"):(c.find(".next").data("page",a+1),c.find(".last").data("page",b),c.find(".next, .last").removeClass("hidden")),c.find("> li").removeClass("selected"),d=c.find(".page"),5>=b)for(e=h=0,j=d.length;j>h;e=++h)f=d[e],$(f).data("page",e+1),e+1===a&&$(f).addClass("selected"),e>=b?$(f).addClass("hidden"):$(f).removeClass("hidden");else for(d.removeClass("hidden"),g=[],g=3>a?[1,2,3,4,5]:a>=b-2&&b>=a?function(){n=[];for(var a=l=b-4;b>=l?b>=a:a>=b;b>=l?a++:a--)n.push(a);return n}.apply(this):function(){o=[];for(var b=m=a-2,c=a+2;c>=m?c>=b:b>=c;c>=m?b++:b--)o.push(b);return o}.apply(this),e=i=0,k=d.length;k>i;e=++i)f=d[e],g[e]===a&&$(f).addClass("selected"),$(f).data("page",g[e]).find("a").text(g[e]);c.show()}else c.hide()},b.prototype.change=function(a){var b;b=this,this.$("> li").click(function(){var c;c=$(this),c.hasClass("selected")||(b.$("> li.selected").removeClass("selected"),c.addClass("selected"),a())})},b.prototype.page=function(a){return null!=a?void(a!==this.page&&this.update(a,this.pagecount)):(a=this.$(".selected").data("page"),parseInt(a))},b}(ControlBar),Playbar=function(a){function b(a){this.el=a,b.__super__.constructor.call(this,this.el),this._lasthighlight=-1,this._data=[],this._wheelstatus={}}return __extends(b,a),b.prototype.show=function(a){a?this.el.show():this.el.hide()},b.prototype.bind=function(){var a;this.$(".mpi").click(function(){GG.gekijou.emit("play")}),this.$(".mpfo").click(function(a){var b;b=1-a.offsetY/$(this).height(),GG.gekijou.emit("pos",b)}),a=this.$(".mpo"),this.$(".mplr").draggable({axis:"y",containment:a,drag:function(){GG.gekijou.emit("pause")},stop:function(){var b,c,d,e,f;b=$(this),e=b.offset().top,d=a.offset().top,c=a.height(),f=c-(e-d),b.attr("style",""),GG.gekijou.emit("pos",f/c)}}),"dev"!==GG.env?(this.$(".mpiloopo").click(function(){var a;a=$(this),a.hasClass("mpiloopa")?(GG.gekijou.autoReplay(!1),a.removeClass("mpiloopa")):(GG.gekijou.autoReplay(!0),a.addClass("mpiloopa"))}),$(document).keydown(function(a){switch(a.which){case 32:GG.gekijou.emit("play");break;case 38:GG.gekijou.emit("pause");break;case 40:if(GG.gekijou.isplaying()&&GG.bubble.isbottom())return void GG.gekijou.emit("next")}})):($(document).keydown(function(a){var b;switch(a.which){case 38:if(GG.gekijou.isplaying())return;if(b=GG.em.currentIndex(),b+1>=GG.em.length())return;GG.gekijou.reset(),GG.gekijou.moveTo(b+1);break;case 40:if(GG.gekijou.isplaying())return;if(b=GG.em.currentIndex(),0>b-1)return;GG.gekijou.reset(),GG.gekijou.moveTo(b-1)}}),chatBox.isMobile?this.bindMobile():this.bindDesktop())},b.prototype.bindDesktop=function(){var a;a=this,$("#commentCanvas")[0].onmousewheel=function(b){var c;c=!1,b.deltaY<0?c="up":b.deltaY>0&&(c="down"),c&&(a._wheelstatus.type!==c||(new Date).valueOf()-a._wheelstatus.lasttime>800?a._wheelstatus={type:c,lasttime:(new Date).valueOf(),deltaY:0,tigger:!1}:(a._wheelstatus.deltaY+=b.deltaY,a.onscroll()))}},b.prototype.bindMobile=function(){var a;a=this,document.addEventListener("touchstart",function(b){return a._wheelstatus={touches:b.touches[0]}},!1),document.addEventListener("touchend",function(b){var c;return c=a._wheelstatus.touches.clientY-b.changedTouches[0].clientY,a._wheelstatus={tigger:!1,deltaY:c},a.onscroll()},!1)},b.prototype.onscroll=function(){this._wheelstatus.tigger||(this._wheelstatus.deltaY<-10?(this._wheelstatus.tigger=!0,GG.gekijou.isplaying()&&GG.gekijou.emit("pause")):this._wheelstatus.deltaY>10&&GG.bubble.isbottom()&&(GG.gekijou.isplaying()?this._wheelstatus.deltaY>100&&(this._wheelstatus.tigger=!0,GG.gekijou.emit("next")):(this._wheelstatus.tigger=!0,GG.gekijou.isfinished()||GG.gekijou.emit("play"))))},b.prototype.preload=function(a){return a*=100,this.$(".mppl").css("height",""+a+"%")},b.prototype.pos=function(a){return a*=100,this.$(".mpl").css("height",""+a+"%")},b.prototype.clear=function(){return this.$(".mpfs").html("")},b.prototype.data=function(a){var b,c,d,e,f,g,h,i,j;for(c="",d=i=0,j=a.length;j>i;d=++i)f=a[d],g=100-100*f.pos,e=GG.util.escape(f.name),c+='<div id="event'+f.id+'" class="mpf" style="top: '+g+'%;">\n  <div class="mpfl"></div>',"dev"===GG.env&&(c+='<div data-event-index="'+d+'" class="mpfi"><span>'+e+"</span></div>"),c+="</div>";this.$(".mpfs").html(c),this._data=a,"dev"===GG.env&&(h=this,b=this.$(".mpfi"),b.click(function(a){var b;d=$(this).data("event-index"),d>=0&&(b=GG.chara.currentId(),GG.gekijou.isplaying()&&GG.gekijou.pause(),GG.gekijou.reset(),GG.gekijou.moveTo(d),GG.chara.currentId()!==b&&GG.chara.selectId(b)),a.stopPropagation()}),b.dblclick(function(a){var b,c;return d=$(this).data("event-index"),d>=0&&(b=GG.em.get(d)),b&&(c=$("#editeventmodal"),c.data("event-index",d),c.find("#editevent_name").val(b.name),c.find("#editevent_time").val(b.time),moTool.showModalBox(c)),a.stopPropagation(),!1}))},b.prototype.highlight=function(a){var b;"dev"===GG.env&&(this._lasthighlight>=0&&(b="#event"+this._lasthighlight,this.$(b).removeClass("highlight")),b="#event"+a,this.$(b).addClass("highlight"),this._lasthighlight=a)},b.prototype.moveToIndex=function(a){a>=0&&a<this._data.length&&(this.pos(this._data[a].pos),this.highlight(a))},b.prototype.moveToLast=function(){var a,b;this._data.length>0&&(b=this._data,a=b[b.length-1],this.pos(a.pos))},b.prototype.moveToBegin=function(){this.pos(0)},b.prototype.start=function(){this.$(".mpi").removeClass("mpir").addClass("mpip")},b.prototype.pause=function(){this.$(".mpi").removeClass("mpir").removeClass("mpip")},b.prototype.finish=function(){this.$(".mpi").removeClass("mpip").addClass("mpir")},b}(ControlBar),Toolbar=function(a){function b(a){this.el=a,b.__super__.constructor.call(this,this.el),this._display={dm:!0,sv:!1,f:!1}}return __extends(b,a),b.prototype.display=function(a,b){return null!=b&&(this._display[a]=b),this._display[a]},b.prototype["switch"]=function(a){return this._display[a]=!this._display[a]},b.prototype.refresh=function(){var a;return"dev"!==GG.env?(a=this.$(".mppm"),GG.opts.instantshow?a.addClass("mppmis"):a.removeClass("mppmis")):void 0},b.prototype.setVolume=function(a){this.$(".mpsvbl").css("width",a),a>0?this.$(".mpsv").removeClass("mpsvc"):this.$(".mpsv").addClass("mpsvc"),this._volume=a,store.set("volume",a),GG.em.setVolume(a)},b.prototype.getVolume=function(){return this._volume},b.prototype.initVolume=function(){var a;a=parseInt(store.get("volume")),a&&0===a||(a=100),this.$(".mpsvblr").css("left",(100-a)/100*88),this.$(".mpsvbl").css("width",a),this._volume=a},b.prototype.initStatus=function(){var a;a=GG.gekijou.status,a&&(a.good&&this.$(".mpcz").addClass("btnzg"),a.favorite&&this.$(".mpcs").addClass("mpcsg"))},b.prototype.bind=function(){var a,b,c,d,e;c=this,this.initVolume(),this.initStatus(),this.$(".mpsv").click(function(){c["switch"]("sv")?$(this).find(".mpsvo").show():$(this).find(".mpsvo").hide()}),a=this.$(".mpsvbl"),b=this.$(".mpsvblr"),e=function(){var a,d,e,f;e=b.offset().left,a=b.parent().offset().left,f=e-a,d=100*(100-f-12)/88,c.setVolume(d)},b.draggable({axis:"x",containment:"parent",drag:function(a){e()},stop:function(){e()}}),a.click(function(d){var e;e=d.offsetX+100-a.width(),b.css("left",e/100*88),c.setVolume(100-e),d.stopPropagation()}),b.click(function(a){a.stopPropagation()}),this.$(".mpsvo").click(function(a){b.css("left",a.offsetX/100*88),c.setVolume(100-a.offsetX),a.stopPropagation()}),this.$(".mpcf").click(function(){c["switch"]("f")?$(this).find(".mpcfu").show():$(this).find(".mpcfu").hide()}),"dev"===GG.env?(this.$(".mpcz").hide(),this.$(".mpcs").hide(),this.$(".mppm").remove()):(this.$(".mppm").click(function(a){var b;b=$(this),b.hasClass("mppmis")||(b.addClass("mppmis"),GG.gekijou.setOptions({instantshow:!0}),GG.gekijou.pause(),GG.gekijou.play())}),d=function(a,b,c){var d;return GG.user?(d=b?"add":"remove",void moTool.postAjax({url:"/gekijou/"+a+"/"+d,value:{_id:GG.gekijou._id},showLoad:!1,callBack:function(a){var b;b=a&&0===a.code,null!=c&&c(b)},showLoad:!1,success:!1,error:!1,json:!1})):void(null!=c&&c(!1))},this.$(".mpcz").click(function(){var a,b;a=$(this),b=a.hasClass("btnzg"),d("good",!b,function(c){c&&(b?a.removeClass("btnzg"):a.addClass("btnzg"))})}),this.$(".mpcs").click(function(){var a,b;a=$(this),b=a.hasClass("mpcsg"),d("favorite",!b,function(c){c&&(b?(a.removeClass("mpcsg"),moTool.showSuccess("已成功取消收藏！")):(a.addClass("mpcsg"),moTool.showSuccess("已成功添加收藏！")))})}))},b}(ControlBar),Editorbar=function(a){function b(a,c){this.el=a,this.editor=c,b.__super__.constructor.call(this,this.el),this.gekijou=this.editor.gekijou,this.em=this.editor.gekijou.em,this.pb=this.editor.gekijou.pb,this.imgtool=new ImageTools,this._extend=!1,this._emotion_display=!1}return __extends(b,a),b.prototype.setId=function(a){var b;b=$("#savemodal"),b.find("#gekijou_id").val(a),this.showpreview()},b.prototype.getId=function(){var a;return a=$("#savemodal"),a.find("#gekijou_id").val()},b.prototype.showpreview=function(){var a;return a=$("#savemodal #gekijou_id").val(),a?($("#gekijoupreviewbtn").attr("href","/gekijou/view/"+a).show(),$("#gekijoudelbtn").show()):void 0},b.prototype.extend=function(a){var b,c;null==a&&(a=!0),!a===this._extend&&(c=this,this._extend=!this._extend,b=this.$("#inputboxtextarea"),this._extend?(b.val(""),this.el.addClass("full-editor"),setTimeout(function(){b.replaceWith('<div id="inputboxtextarea" contentEditable="true"></div>'),b=c.$("#inputboxtextarea"),b.focus(),b.blur(function(){var a,c,d;a=b.html(),-1!==a.indexOf("<")&&(c=a.replace(/<img [^>]*?src=(".+?")[^>]*?\/?>/gi,"|img:$1|"),d=c.replace(/<.*?>/g,""),a=d.replace(/\|img\:"(.+?)"\|/gi,'<img src="$1" />'),b.html(a))})},300)):(b.html(""),this.showemotion(!1),this.el.removeClass("full-editor"),setTimeout(function(){b.replaceWith('<textarea id="inputboxtextarea" class="pie" placeholder="文字,弹幕,音频,中二咒语" maxlength="200"></textarea>'),c.bindeditor(),b=c.$("#inputboxtextarea"),b.focus()},300)))},b.prototype.showcmdbox=function(a){var b;b=this.$("#inputboxcmdbox"),b.is(":visible")!==a&&(a?(b.show(),setTimeout(function(){b.css("max-height",200)},0)):(b.css("max-height",0),setTimeout(function(){b.hide()},150)))},b.prototype.selectcmdbox=function(a){var b,c,d,e,f,g,h,i;for(b=this.$("#inputboxcmdbox"),d=b.find("p"),f=-1,e=h=0,i=d.length;i>h;e=++h)if(g=d[e],c=$(g),c.hasClass("select")){f=e;break}if(a)f<d.length-1&&(f>=0&&$(d[f]).removeClass("select"),$(d[f+1]).addClass("select"));else{if(!b.is(":visible"))return;f>=0&&$(d[f]).removeClass("select"),f-1>=0&&$(d[f-1]).addClass("select")}},b.prototype.setcmd=function(a){var b;b=this.$("#inputboxtextarea"),a&&(b.val(a),this.showcmdbox(!1),b.focus())},b.prototype.bindeditor=function(){var a,b,c;c=this,b=this.$("#inputboxtextarea"),a=this.$("#inputboxcmdbox"),b.keydown(function(b){var d,e,f;c._extend||(8===b.which?2<=(f=this.value.length)&&4>=f?c.showcmdbox(!0):this.value.length<=1&&c.showcmdbox(!1):40===b.which?(b.preventDefault(),c.showcmdbox(!0),c.selectcmdbox(!0)):38===b.which?(b.preventDefault(),c.selectcmdbox(!1)):13===b.which?(b.preventDefault(),a.is(":visible")?(d=a.find("p.select"),d&&d.length>0&&(e=d.data("cmd"),c.setcmd(e))):c.$("#inputboxtextareapostbtn").click()):191===b.which||47===b.which?c.showcmdbox(!0):this.value.length>=index.mo.maxLength&&b.preventDefault())})},b.prototype.searchemotion=function(){var a,b,c,d;c=this,d="/theatre/api/emojilist",a=$("#emotion-list .searchinput"),b=a.val(),b&&(d+="?name="+b),$.ajax({url:d,dataType:"json",success:function(a){var b,d,e,f,g,h;if(c._emotion_load=!0,a&&"success"===a.state&&a.info){for(b=$("#emotion-list .emotions"),e="",h=a.info,f=0,g=h.length;g>f;f++)d=h[f],e+='<img src="'+d.front_cover+'" title="'+GG.util.escape(d.title)+'" />';b.html(e),e&&b.find("img").click(function(){var a;c._extend&&(a=c.$("#inputboxtextarea"),a.append('<img src="'+$(this).attr("src")+'" />'))})}}})},b.prototype.showemotion=function(a){var b,c;null==a&&(a=!0),b=$("#emotion-list"),a?(this._emotion_load||this.searchemotion(),c=this.$("#insert-emotion").offset(),b.css("left",c.left+40).show().animate({left:c.left+50,opacity:1}),this._emotion_display=!0):(b.hide().css("opacity",0),this._emotion_display=!1)},b.prototype.bind=function(){var a,b,c,d,e,f,g,h;h=this,a=this.$("#extend-input"),a.click(function(){h.extend(!h._extend)}),e=this.$("#insert-emotion"),e.click(function(){h.showemotion(!h._emotion_display)}),$("#emotion-list .searchbtn").click(function(){h.searchemotion()}),f=this.pb.$("#mpiloop"),f.addClass("mpiloopa newevent"),f.text(""),f.click(function(){var a,b;a=$("#neweventmodal"),b=h.em.lastid()+1,a.find("#newevent_name").val("新事件 "+b),moTool.showModalBox(a)}),$("#neweventokbtn").click(function(){var a,b,c;a=$("#neweventmodal"),b=a.find("#newevent_name").val(),c=parseInt(a.find("#newevent_time").val()),b&&c>=0&&(h.em.insert(b,c),h.gekijou.rearrange(!0),h.gekijou.played(h.em.currentIndex()),moTool.hideModalBox(a))}),$("#editeventokbtn").click(function(){var a,b,c,d,e;c=$("#editeventmodal"),b=c.data("event-index"),d=c.find("#editevent_name").val(),e=parseInt(c.find("#editevent_time").val()),d&&e>=0&&(a=h.em.get(b)),a&&(a.name=d,a.time=e,h.gekijou.rearrange(!0),moTool.hideModalBox(c))}),$("#editeventdelbtn").click(function(){var a,b,c;c=$("#editeventmodal"),b=c.data("event-index"),b>=0&&confirm("确认删除该事件吗？")&&(a=h.em.del(b),h.gekijou.reset(),h.gekijou.rearrange()),moTool.hideModalBox(c)}),g=this.pb.$("#mpisettings"),g.click(function(){var a;a=$("#settingsmodal"),a.find("#cb_show_name").prop("checked",GG.opts.showname),a.find("#cb_instant_show").prop("checked",GG.opts.instantshow),moTool.showModalBox(a)}),$("#settingsokbtn").click(function(){var a,b;a=$("#settingsmodal"),b={showname:a.find("#cb_show_name").prop("checked"),instantshow:a.find("#cb_instant_show").prop("checked")},GG.gekijou.setOptions(b),moTool.hideModalBox(a)}),b=this.pb.$("#mpisave"),b.click(function(){moTool.showModalBox($("#savemodal"))}),$("#gekijouokbtn").click(function(){var a,b,c;a=$("#savemodal"),c=a.find("#gekijou_title").val(),b=a.find("#gekijou_intro").val(),c&&(moTool.hideModalBox(a),h.editor.save(c,b))}),$("#gekijoudelbtn").click(function(){confirm("确认删除该剧场？")&&h.editor["delete"](function(a){return a?setTimeout(function(){return window.location.href="/gekijou/"},1e3):void 0})}),b.show(),d=this.$("#inputboxtextarea"),c=this.$("#inputboxcmdbox"),this.bindeditor(),c.find("p").click(function(){var a;a=$(this).data("cmd"),h.setcmd(a)}),this.$("#inputboxtextareapostbtn").click(function(){var a,b,c;b=h.em.current(),b?(a=h.$("#inputboxtextarea"),h._extend?(c=a.html(),c&&(b.parseAction(c,!0),a.html(""))):(c=a.val(),c&&(b.parseAction(c),a.val(""),h.showcmdbox(!1)))):moTool.showError("请先新建一个事件！")}),this.imgtool.initImageUpload(function(a,b,c){var d,e;if(a||"string"!=typeof c)return void moTool.showError("图片上传失败");if(e=h.em.current())switch(b){case"chat":h._extend?(d=h.$("#inputboxtextarea"),d.append("<img src="+JSON.stringify(c)+" />")):e.showImage(c);break;case"background":e.switchBackground(c)}else moTool.showError("请先新建一个事件！")})},b}(ControlBar);var Chara;Chara=function(){function a(a){this.el=a,this.iconUrlPrefix="http://static.missevan.cn/avatars/",this.charas=[],this._lastid=0,this._showmodal=!1,this._sel=-1,this.pagination=new Paginationbar(this.el.find(".pagelist"))}return a.prototype.add=function(a,b){return null==b&&(b=-1),-1===b?b=this._lastid++:this._lastid=Math.max(this._lastid,b+1),this.charas.push({id:b,username:a.username,showon:a.showon,iconid:a.iconid,iconurl:a.iconurl}),b},a.prototype.sender=function(a){var b;return b=a?{id:a.id,name:a.username,icon:this.iconUrlPrefix+a.iconurl}:null},a.prototype.currentId=function(){return this._sel>=0?this.charas[this._sel].id:-1},a.prototype.currentShowOn=function(){return this._sel>=0?this.charas[this._sel].showon:null},a.prototype.selectId=function(a){var b,c,d,e,f,g;for(c=!1,g=this.charas,d=e=0,f=g.length;f>e;d=++e)if(b=g[d],b.id===a){c=!0,this.select(d);break}return c||this.select(-1),c},a.prototype.removeId=function(a){var b,c,d,e,f;for(f=this.charas,c=d=0,e=f.length;e>d;c=++d)if(b=f[c],b.id===a){this.remove(c);break}},a.prototype.select=function(a){a!==this._sel&&(this._sel>=0&&this.el.find(".charabox:eq("+this._sel+")").removeClass("selected"),a>=this.charas.length&&(a=-1),a>=0?(this.el.find(".charabox:eq("+a+")").addClass("selected"),index.mo.sender=this.sender(this.charas[a])):index.mo.sender=null,this._sel=a)},a.prototype.remove=function(a){a===this._sel&&this.select(-1),this.charas.splice(a,1),this.refresh()},a.prototype.refresh=function(){var a,b,c,d,e,f,g,h,i,j;if(c="",a=this.el.find("#charamodal #charauserlist"),a.html(""),!(this.charas.length<=0)){for(j=this.charas,d=h=0,i=j.length;i>h;d=++h)b=j[d],g=this.sender(b),e=GG.util.escape(b.username),c+='<div id="chara'+b.id+'" class="charabox',d===this._sel&&(c+=" selected"),c+='">\n',"dev"===GG.env&&(c+='<div class="delbtn">x</div>\n'),c+='  <div class="chaticonbox">\n    <img alt="'+e+'" title="'+e+'" src="'+g.icon+'">\n  </div>\n  <div class="clear"></div>\n  <div class="chatusername" style="color:#ffffff;">\n    <span>'+e+"</span>\n  </div>\n</div>";a.html(c),f=this,a.find(".charabox").click(function(){var a,b;b=$(this).attr("id"),a=parseInt(b.replace("chara","")),f.selectId(a)}),a.find(".delbtn").click(function(){var a,b;return b=$(this).parent().attr("id"),a=parseInt(b.replace("chara","")),f.removeId(a),!1})}},a.prototype.searchIcon=function(){var a,b,c,d,e,f,g,h,i,j;for(f=this,h="/theatre/api/iconlist?pagesize=12",e=this.el.find("#soundsearchinput").val(),e&&(h+="&name="+encodeURIComponent(e)),b=this.el.find(".s_m_t_r_b"),g=0,c=i=0,j=b.length;j>i;c=++i)if(a=b[c],$(a).hasClass("s_m_t_r_b_a")){g=$(a).data("catalog");break}g>0&&(h+="&catalog="+g),d=this.pagination.page(),d&&(h+="&p="+d),moTool.getAjax({url:h,callBack:function(a){var b,c,e,g;c=[],e=1,g=0,"success"===a.state&&a.info&&(c=function(){var c,d,e,f;for(e=a.info,f=[],c=0,d=e.length;d>c;c++)b=e[c],f.push({username:b.name,iconid:parseInt(b.id),iconurl:b.avatar});return f}(),d&&(e=d),g=a.pagecount),f.updatePagination(e,g),f.showIcons(c)}})},a.prototype.updatePagination=function(a,b){return this.pagination.update(a,b)},a.prototype.showIcons=function(a){var b,c,d,e,f,g,h,i,j;if(d="",b=this.el.find("#charamodal #selecticonlist"),b.html(""),!(a.length<=0)){for(i=0,j=a.length;j>i;i++)c=a[i],g=this.sender(c),h=JSON.stringify(c),e=GG.util.escape(c.username),d+="<div data-user='"+h+'\' class="charaicon">\n  <div class="chaticonbox">\n    <img alt="'+e+'" title="'+e+'" src="'+g.icon+'">\n  </div>\n  <div class="clear"></div>\n</div>';b.html(d),f=this,b.find(".charaicon").click(function(){f.showCreateModal($(this).data("user"))})}},a.prototype.appendCandidateIcons=function(a,b){var c,d,e,f,g,h,i;if(d=$("#newcharamodal"),c=d.find(".candidate-icons"),!a||a.length<=0)return void c.html("");for(f='<img data-iconurl="'+b+'" src="'+this.iconUrlPrefix+b+'" />\n',h=0,i=a.length;i>h;h++)e=a[h],f+='<img data-iconurl="'+e.avatar+'" src="'+this.iconUrlPrefix+e.avatar+'" />\n';c.html(f),g=this,c.find("img").click(function(){var a,b,c,d;c=$(this),a=c.parents("#newchara_iconlist"),b=a.find(".main-icon"),d=c.data("iconurl"),b.data("iconurl",d),b.attr("src",g.iconUrlPrefix+d)})},a.prototype.showCreateModal=function(a){var b,c,d,e,f,g;c=$("#newcharamodal"),c.find("#newchara_user").data("user",a),c.find("#newchara_username").val(a.username),f=this,e=a.iconurl,g="/theatre/api/actor?id="+a.iconid,$.ajax({url:g,dataType:"json",success:function(a){a&&"success"===a.state&&f.appendCandidateIcons(a.avatars,e)}}),b=c.find("#newchara_iconlist"),d='<img data-iconurl="'+e+'" class="main-icon" src="'+this.iconUrlPrefix+e+'" />',d+='<div class="candidate-icons">加载中…</div>',b.html(d),moTool.showModalBox(c)},a.prototype.bind=function(){var a,b;b=this,a=this.el.find(".mpc"),this.el.find(".sidetext").click(function(){b._showmodal?a.removeClass("showmodal"):a.addClass("showmodal"),b._showmodal=!b._showmodal})},a.prototype.devbind=function(){var a,b;b=this,this.el.find("#selecticon").show(),a=this.el.find("#charabtnlist"),a.show(),a.find("#nocharabtn").click(function(){b.select(-1)}),this.el.find(".s_m_t_r_b").click(function(){$(this).hasClass("s_m_t_r_b_a")||(b.el.find(".s_m_t_r_b.s_m_t_r_b_a").removeClass("s_m_t_r_b_a"),$(this).addClass("s_m_t_r_b_a")),b.el.find("#soundsearchinput").val(""),b.pagination.page(1),b.searchIcon()}),this.el.find("#searchbtn").click(function(){b.pagination.page(1),b.searchIcon()}),this.el.find("#soundsearchinput").keydown(function(a){13===a.which&&(b.pagination.page(1),b.searchIcon())}),$("#newcharaokbtn").click(function(){var a,c,d,e,f;a=$("#newcharamodal"),d=a.find("#newchara_username").val(),d&&(f=a.find("#newchara_user").data("user"),c=a.find("#newchara_iconlist .main-icon").data("iconurl"),e=a.find("input[name=rd_chara_showon]:checked").val(),f.username=d,f.iconurl=c,f.showon="right"===e?"right":"left",b.add(f),b.refresh(),moTool.hideModalBox(a))}),this.pagination.change(function(){b.searchIcon()})},a.prototype.init=function(a){this.bind(),"dev"===GG.env?(this.devbind(),this.charas.length>0?this.refresh():GG.user&&(this.selectId(this.add(GG.user)),this.refresh()),this.searchIcon()):(this.el.addClass("non-editor"),this.refresh()),a()},a.prototype.parse=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p;for(c=GG.util.splitblock(a),m=0,o=c.length;o>m;m++)if(b=c[m],k=GG.util.splitprop(b.title),j=GG.util.splitline(b.content),k.length>=2&&"define"===k[0]&&j.length>0)try{for(e=parseInt(k[1]),d={id:e,username:JSON.parse(k[2]),subtitle:""},f=n=0,p=j.length;p>n;f=++n)switch(h=j[f],i=GG.util.splitprop(h),i[0]){case"actor":i.length>=2&&(d.iconid=parseInt(i[1]));break;case"icon":i.length>=2&&(g=1,l=/^[0-9]+$/,l.test(i[1])&&(d.iconid=parseInt(i[1]),g++),d.iconurl=JSON.parse(i[g]),i[g+1]&&(d.iconcolor=JSON.parse(i[g+1])));break;case"showon":i.length>=2&&(d.showon="right"===i[1]?"right":"left");break;case"subtitle":i.length>=2&&i[1]&&(d.subtitle=JSON.parse(i[1]))}this.add(d,e)}catch(q){}},a}();var SoundAlbum;SoundAlbum=function(){function a(){this.albums=[],this.sounds=[]}return a.prototype.init=function(){return $("#soundmusic").click(function(){$("#chatmusic").fadeToggle(500)})},a.prototype.load=function(a){var b,c,d,e,f,g;if($("#chatmusic").html(""),this.albums.length>0)for(c=this.albums.length,d=0,g=this.albums,e=0,f=g.length;f>e;e++)b=g[e],this.loadAlbum(b,function(){d++,d>=c&&null!=a&&a()},!0);else null!=a&&a()},a.prototype.set=function(a){var b,c,d,e,f;if(c=typeof a,"string"===c)for(d=a.split(","),e=0,f=d.length;f>e;e++)b=d[e],b=parseInt(b),this.albums.indexOf(b)<0&&this.albums.push(b);else"number"===c&&this.albums.push(c)},a.prototype.loadAlbum=function(a,b,c){var d,e;d=this.albums.indexOf(a)<0,c||d?(d&&this.albums.push(a),e=this,moTool.getAjax({url:"/sound/soundlist?albumid="+a,showLoad:!1,callBack:function(a){var c,d,f,g;if(a&&"success"===a.state&&a.info&&a.info.sounds&&a.info.sounds.length>0)for(g=a.info.sounds,d=0,f=g.length;f>d;d++)c=g[d],e.addSound(c);null!=b&&b()}})):null!=b&&b()},a.prototype.addSound=function(a){var b,c,d;return $("#sound"+a.id).length||(b=$('<div id="sound'+a.id+'" class="chatmusic">\n  <div class="soundtitle">'+a.soundstr+'</div>\n  <img title="标题: '+a.soundstr+"&#10;UP主: "+a.username+"&#10;声音ID: "+a.id+'" src="'+a.front_cover+'" />\n</div>'),b.appendTo($("#chatmusic")),"dev"!==GG.env)?void 0:(d=parseInt(a.id),c=this,void b.click(function(){var a,b;return a=$("#soundtype"),b=a.find("input[name=sound_type]:checked").val(),"chara"===b?GG.em.doAction("sound",d):GG.em.doAction("sound",b,d),c.hideSelect()}))},a.prototype.hideSelect=function(){var a;a=$("#chatmusic"),a.is(":visible")&&a.fadeOut(500)},a.prototype.showSelect=function(){var a;a=$("#chatmusic"),a.is(":visible")||a.fadeIn(500)},a}();var SoundCollection;SoundCollection=function(){function a(){this._soundurlmap={},this._bmute=!1}return a.prototype.init=function(a){return soundManager.onready(function(){return null!=a?a():void 0})},a.prototype.stopAll=function(){return soundManager.stopAll()},a.prototype.pauseAll=function(){return soundManager.pauseAll()},a.prototype.resumeAll=function(){return soundManager.resumeAll()},a.prototype.mute=function(a){this._bmute=a,this._bmute&&this.stopAll()},a.prototype.play=function(a,b,c){var d,e,f;return e=this._soundurlmap[a],e&&(f=soundManager.getSoundById(e),f&&f.stop()),"stop"!==b&&b?(this._bmute?this._soundurlmap[a]=null:(this._soundurlmap[a]=b,f=soundManager.getSoundById(b),f&&(d={},"background"===a&&(d.onfinish=function(){return f.play(d)}),f.play(d))),void(null!=c&&c())):void(this._soundurlmap[a]=null)},a.prototype.stop=function(a){var b,c;b=this._soundurlmap[a],b&&(c=soundManager.getSoundById(b),c&&c.stop(),this._soundurlmap[a]=null)},a}();var GAction,GEvent,GEventManager;GAction=function(){function a(a){this.type=a,"text"===this.type?this.ready=!0:this.ready=!1}return a.prototype.load=function(a){var b,c;if(this.ready)return void a();switch(c=this,this.type){case"image":case"background":b=new Image,b.onload=function(){c.ready=!0,a()},b.src=this.val,c.img=b;break;case"sound":if("dev"!==GG.env&&GG.opts.instantshow)return void a();moTool.getAjax({url:"/sound/getsound?soundid="+this.val,showLoad:!1,callBack:function(b){var d,e,f;e=b.successVal.sound,f=e.soundurl,d=soundManager.createSound({id:f,url:index.mo.soundPath+f,multiShot:!1,onload:function(){c.ready=!0,a()}}),d.load(),c.Jsound=e,c.sound=d}});break;default:a()}},a.prototype.attachlaststate=function(){var a;a=$("#chatbox .chatmessage:first"),a&&1===a.length&&(this.line=index.mo.chatLine,a.attr("id","chatline"+this.line),index.mo.chatLine++)},a.prototype.attacheditor=function(){var a;this.line>=0&&(a=$("#chatline"+this.line),a.prepend('<div class="line-editor" data-line="'+this.line+'" data-actionid="">\n  <div class="line-del">x</div>\n</div>'),a.find(".line-del").click(function(b){var c;c=$(this).parent().data("line"),GG.em.removeLine(parseInt(c))&&a.remove(),b.stopPropagation()}))},a.prototype.stop=function(){var a;"sound"===this.type?(a=this.stype,"chara"===this.stype&&(a+=":"+this.chara),GG.sound.stop(a)):"background"===this.type&&GG.bubble.background(null)},a.prototype.run=function(a){var b;b=this,this.load(function(){var c,d,e,f,g,h;switch(d=!1,null!=b.chara&&(d=GG.chara.selectId(b.chara)),c=function(){return"dev"===GG.env&&b.attacheditor(),null!=a?a():void 0},b.type){case"text":return d?(b.line=index.mo.chatLine,GG.bubble.popup({msg:b.val,type:1,sender:index.mo.sender,showon:GG.chara.currentShowOn()}),c()):("dev"===GG.env&&moTool.showError("请先选择一个角色"),void c());case"state":if("text"===b.stype)return b.line=index.mo.chatLine,h=b.val,-1!==b.chara&&(h="►► "+index.mo.sender.name+" "+h),GG.bubble.text(h),c();if("image"===b.stype)return GG.bubble.stateimage(b.val,function(){b.line=index.mo.chatLine-1,c()});break;case"image":return-1!==b.chara?GG.bubble.popup({msg:b.val,type:7,sender:index.mo.sender,showon:GG.chara.currentShowOn()},function(){b.line=index.mo.chatLine-1,
c()}):GG.bubble.stateimage(b.val,function(){b.line=index.mo.chatLine-1,c()});case"background":return GG.bubble.background({url:b.val,effect:b.effect},function(){"dev"===GG.env&&(b.line=index.mo.chatLine,h=": 切换背景",GG.bubble.text(h)),c()});case"sound":if("dev"!==GG.env&&GG.opts.instantshow)return void c();switch(g=b.Jsound?b.Jsound.soundstr:"",f="",e="",b.stype){case"chara":f="播放了声音 「"+g+"」",index.mo.sender&&index.mo.sender.name&&(f=index.mo.sender.name+" "+f),e="chara:"+b.chara;break;case"effect":f="音效 「"+g+"」",e="effect";break;case"background":f="背景乐 「"+g+"」",e="background"}return GG.sound.play(e,b.Jsound.soundurl,function(){"background"===b.stype&&chatBox.addInfo("声音播放提示",f),"dev"===GG.env&&(b.line=index.mo.chatLine,h=": "+f,GG.bubble.text(h)),c()})}})},a}(),GEvent=function(){function a(a,b,c){this.id=a,this.name=b,this.time=c,this.actions=[]}return a.prototype.action=function(a,b,c,d){var e;switch(e=new GAction(a),a){case"text":e.chara=this.parseCharaId(b),e.val=c,d||e.run();break;case"image":e.chara=this.parseCharaId(b),e.val=c,d||e.run(function(){});break;case"background":e.effect=b,e.val=c,d||e.run();break;case"sound":this.isCharaId(b)?(e.chara=this.parseCharaId(b),e.stype="chara"):(e.chara=-1,e.stype=b),e.val=c,d||e.run(function(){});break;case"state":"text"===b.stype&&(e.chara=this.parseCharaId(b.chara)),e.stype=b.stype,e.val=c,d||e.run(function(){});break;default:return}this.actions.push(e)},a.prototype.removeLine=function(a){var b,c,d,e,f,g;for(c=!1,g=this.actions,d=e=0,f=g.length;f>e;d=++e)if(b=g[d],b.line===a){b.stop(),this.actions.splice(d,1),c=!0;break}return c},a.prototype.run=function(a,b){var c;null==a&&(a=0),"function"==typeof a&&(b=a,a=0),a<this.actions.length?(c=this,this.actions[a].run(function(){c.run(a+1,b)})):null!=b&&b()},a.prototype.isCharaId=function(a){switch(typeof a){case"string":return/^(no)?chara/.test(a);case"number":return!0;default:return!1}},a.prototype.parseCharaId=function(a){var b;if("number"==typeof a)return a;if("string"==typeof a){if("nochara"===a)return-1;if(b=a.split(":"),2===b.length&&"chara"===b[0])return parseInt(b[1])}return-1},a.prototype.parseAction=function(a,b){var c,d,e,f,g;if("/"!==a[0]||b)return this.action("text",GG.chara.currentId(),a);if(d=GG.util.splitcommand(a))switch(d[0]){case"sound":if(g=d[1],e=parseInt(d[2])){if("chara"===g&&-1===GG.chara.currentId())return;return"chara"===g&&(g+=":"+GG.chara.currentId()),this.action("sound",g,e)}break;case"album":if(c=parseInt(d[1]))return GG.album.loadAlbum(c,function(){GG.album.showSelect()});break;case"state":if(f=d[1])return this.action("state",{stype:"text",chara:GG.chara.currentId()},f)}},a.prototype.showImage=function(a){var b;return b=GG.chara.currentId(),-1!==b?this.action("image",b,a):this.action("state",{stype:"image"},a)},a.prototype.switchBackground=function(a,b){return this.action("background","default",a)},a.prototype.parse=function(a){var b,c,d,e,f,g;if(d=GG.util.splitline(a),d.length>0)for(f=0,g=d.length;g>f;f++){b=d[f],c=GG.util.splitprop(b);try{"background"===c[0]?c[1]=JSON.parse(c[1]):"state"===c[0]&&(this.isCharaId(c[1])?(e="text",c[1]={stype:e,chara:c[1]}):(e=c[1],c[1]={stype:e},"text"===e&&('"'===c[2][0]?c[1].chara=-1:(c[1].chara=c[2],c[2]=c[3])))),this.action(c[0],c[1],JSON.parse(c[2]),!0)}catch(h){}}},a.prototype.realtime=function(){return this.time},a}(),GEventManager=function(){function a(){this.events=[],this._lastid=0,this._event=null,this._timecount=0,this._curtime=0,this._currentIndex=-1}return a.prototype.lastid=function(){return this._lastid},a.prototype.current=function(a){return null==a&&(a=-1),-1!==a&&(this._currentIndex=a,this._event=this.events[a]),this._event},a.prototype.currentIndex=function(){return this._currentIndex},a.prototype.next=function(){return this._currentIndex<this.events.length-1?(this._currentIndex++,this._event=this.events[this._currentIndex],!0):!1},a.prototype.totaltime=function(a){var b,c,d,e,f,g;if(null==a&&(a=-1),-1!==a)for(b=0,g=this.events,d=e=0,f=g.length;f>e;d=++e){if(c=g[d],d>=a)return b;b+=c.realtime()}return this._timecount},a.prototype.calc=function(){var a,b,c,d,e,f,g,h,i,j;for(c=[],a=0,d=0,i=this.events,e=0,g=i.length;g>e;e++)b=i[e],d+=b.realtime();for(this._timecount=d,j=this.events,f=0,h=j.length;h>f;f++)b=j[f],c.push({id:b.id,pos:a/d,name:b.name}),a+=b.realtime();return 1===c.length&&(c[0].pos=.5),c},a.prototype.doAction=function(a,b,c){this._event&&(c||(c=b,b=GG.chara.currentId()),this._event.action(a,b,c))},a.prototype.moveToBegin=function(){this._currentIndex=-1,this._event=null},a.prototype.getNeedPreload=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;for(k=0,i=[],j=this.totaltime(),t=this.events,c=n=0,q=t.length;q>n;c=++n){for(b=t[c],m=b.realtime(),f=b.actions.length,u=b.actions,d=o=0,r=u.length;r>o;d=++o)switch(a=u[d],h=(k+(d+1)*m/f)/j,a.type){case"text":if(g=a.val.match(/<img [^>]*?src="(.+?)"[^>]*?\/?>/gi))for(e=p=0,s=g.length;s>p;e=++p)l=g[e],i.push({pos:h,type:"image",imgurl:l,action:a});break;case"state":"image"===a.stype&&i.push({pos:h,type:"image",imgurl:a.val,action:a});break;case"image":i.push({pos:h,type:"image",imgurl:a.val,action:a});break;case"background":i.push({pos:h,type:"image",imgurl:a.val,action:a});break;case"sound":i.push({pos:h,type:"sound",soundid:a.val,action:a})}k+=m}return i},a.prototype.setVolume=function(a){var b,c,d,e,f;if(null==a&&(a=-1),-1===a&&(a=GG.gekijou.tb.getVolume()),c=this.current())for(f=c.actions,d=0,e=f.length;e>d;d++)b=f[d],"sound"===b.type&&b.sound&&b.sound.setVolume(a)},a.prototype.getClosetIndex=function(a){var b,c,d,e,f,g;for(d=0,g=this.events,c=e=0,f=g.length;f>e;c=++e){if(b=g[c],d>a)return c-1;d+=b.realtime()}return this.events.length-1},a.prototype.removeLine=function(a){var b,c,d,e,f;if(b=this.current(),c=!1,b&&b.removeLine(a)&&(c=!0),!c)for(f=this.events,d=0,e=f.length;e>d;d++)b=f[d],b.removeLine(a)&&(c=!0);return c},a.prototype.runAtTime=function(a){var b,c,d,e,f,g;for(d=0,g=this.events,c=e=0,f=g.length;f>e&&(b=g[c],a>=d);c=++e)this._currentIndex<c&&this.next()&&(this.run(),GG.gekijou.emit("step")),d+=b.realtime();return a>=this._timecount&&this._curtime<this._timecount&&GG.gekijou.emit("end"),this._curtime=a,this._currentIndex},a.prototype.runAll=function(){var a,b;b=this,(a=function(){b.next()?b.run(a):GG.gekijou.emit("end")})()},a.prototype.run=function(a){this._event&&(this.setVolume(),this._event.run(a))},a.prototype.length=function(){return this.events.length},a.prototype.get=function(a){return this.events[a]},a.prototype.del=function(a){this.events.splice(a,1)},a.prototype.insert=function(a,b){var c,d,e;return null==b&&(b=2e3),0<=(e=this._currentIndex)&&e<this.events.length-1?(d=this._lastid++,c=new GEvent(d,a,b),this.events.splice(this._currentIndex+1,0,c),this._event=c,this._currentIndex++,this._timecount+=c.realtime()):c=this.add(a,b),c},a.prototype.add=function(a,b,c){var d;return null==b&&(b=2e3),null==c&&(c=-1),-1===c?c=this._lastid++:this._lastid=c+1,d=new GEvent(c,a,b),this.events.push(d),this._event=d,this._currentIndex=this.events.length-1,this._timecount+=d.realtime(),d},a.prototype.parse=function(a){var b,c,d,e,f,g,h,i,j;for(this._timecount=0,c=GG.util.splitblock(a),i=0,j=c.length;j>i;i++)b=c[i],g=GG.util.splitprop(b.title),g.length>=4&&"define"===g[0]&&(e=parseInt(g[1]),f=JSON.parse(g[2]),h=parseInt(g[3]),d=this.add(f,h,e),d.parse(b.content))},a}();var Gekijou;Gekijou=function(){function a(a){this.opts=null!=a?a:{},this.bubble=new ChatBubble,this.pb=new Playbar($("#m")),this.tb=new Toolbar($("#common-toolbar")),this.chara=new Chara($("#chara-toolbar")),this.album=new SoundAlbum,this.sound=new SoundCollection,this.em=new GEventManager,this.util=new Util,this._playing=!1,this._ready=!1,this._playedtime=0,new GGManager,GG.gekijou=this,GG.opts=this.opts,GG.bubble=this.bubble,GG.chara=this.chara,GG.album=this.album,GG.sound=this.sound,GG.em=this.em,GG.util=this.util}return a.prototype.setOptions=function(a){var b,c;for(b in a)switch(c=a[b],this.opts[b]=c,b){case"env":GG.env=c;break;case"showname":this.bubble.showname(c);break;case"instantshow":this.sound.mute(c),this.tb.refresh(),"dev"!==this.opts.env&&this.pb.show(!c);break;case"editormode":this.setOptions({instantshow:"simple"===c})}return this.opts},a.prototype.initChatBox=function(){this.bubble.init(),chatBox.loadChatOption(),chatBox.loadUser(),chatBox.insertPrivateBox=function(){},chatBox.isMobile||index.js.loadChatDm()},a.prototype.initUser=function(){var a,b;a=$("#user"),a&&a.length>0&&(this.status=a.data("status"),b=a.data("user"),b&&"object"==typeof b&&(GG.user=b))},a.prototype.init=function(a){var b,c,d;this.initUser(),this.initChatBox(),this.pb.bind(),this.tb.bind(),this.album.init(),this.util.init(),b=$("script#gekijouscript"),c="",b&&b.length>0&&(this.setId(b.data("id")),c=this.util.unescape(b.text()),this.parse(c)),d=this,this.chara.init(function(){d.sound.init(function(){return null!=a?a():void 0})})},a.prototype.rearrange=function(a){var b,c,d;return null==a&&(a=!1),this.pb.clear(),d=this.em.calc(),this.pb.data(d),a&&(b=this.em.currentIndex(),b>=0)?void this.pb.moveToIndex(b):void("dev"!==GG.env?this.pb.moveToBegin():(c=this.em.length(),c>0&&this.moveTo(c-1)))},a.prototype.parse=function(a){var b,c,d,e,f,g,h,i;if(a&&(a=a.trim()),a){for(c=this.util.splitblock(a),d=0,g=c.length;g>d;d++)b=c[d],"setup"===b.title&&this.parseSetup(b.content);for(e=0,h=c.length;h>e;e++)b=c[e],"chara"===b.title&&this.chara.parse(b.content);for(f=0,i=c.length;i>f;f++)b=c[f],"event"===b.title&&this.em.parse(b.content);this.chara.select(0),this.album.load(),this.rearrange()}},a.prototype.parseSetup=function(a){var b,c,d,e,f,g,h;for(e=this.util.splitline(a),b=g=0,h=e.length;h>g;b=++g)switch(c=e[b],d=this.util.splitprop(c),d[0]){case"album":this.album.set(d[1]);break;case"showname":case"instantshow":f={},"off"===d[1]?(f[d[0]]=!1,this.setOptions(f)):"on"===d[1]&&(f[d[0]]=!0,this.setOptions(f))}},a.prototype.reset=function(){this.bubble.reset(),this._finished=!1,this._playedtime=0,this.em.moveToBegin(),this.pb.moveToBegin()},a.prototype.ready=function(){this._ready=!0,$("#chatmain").addClass("gekijou-ready")},a.prototype.preload=function(a){var b,c,d;c=this.em.getNeedPreload(),c.length<=0?(this.pb.preload(1),this.ready(),null!=a&&a()):(d=this,(b=function(a,e){return a>=c.length?e():c[a].action.load(function(){return d.pb.preload(c[a].pos),b(a+1,e)})})(0,function(){return d.pb.preload(1),d.ready(),null!=a?a():void 0}))},a.prototype.moveTo=function(a){this.pb.moveToIndex(a),this.em.current(a),this.played(a),this.sound.stopAll(),this.em.run()},a.prototype.emit=function(a,b){this.on(a,b)},a.prototype.on=function(a,b){var c,d;switch(a){case"pause":this._playing&&this.pause();break;case"play":this._playing?this.pause():(this._finished&&this.reset(),this.play());break;case"next":this._finished||this.playNext();break;case"step":this.scrollToBottom();break;case"pos":c=this.em.getClosetIndex(b*this.em.totaltime()),c>=0&&(this._playing&&this.pause(),this.reset(),this.moveTo(c),this.play());break;case"end":this.finish(),this.opts.autoReplay&&(d=this,setTimeout(function(){return d.reset(),d.play()},0))}},a.prototype.autoReplay=function(a){this.setOptions({autoReplay:a})},a.prototype.playNext=function(){this.em._currentIndex<this.em.events.length-1&&this.played(this.em._currentIndex+1)},a.prototype.isplaying=function(){return this._playing},a.prototype.isfinished=function(){return this._finished},a.prototype.played=function(a){return this._playedtime=this.em.totaltime(a),this._playedtime<=0?this._playedtime=1:void 0},a.prototype.play=function(a){var b;null==a&&(a=-1),this._playing||(this._playing=!0,this._finished=!1,this.pb.start(),this._lastplaytime=(new Date).valueOf(),b=this,this.opts.instantshow&&"dev"!==this.opts.env?(this.sound.resumeAll(),this.em.runAll()):(this._timer=setInterval(function(){var c,d,e;return c=(new Date).valueOf(),b._playedtime+=c-b._lastplaytime,b._lastplaytime=c,d=b.em.runAtTime(b._playedtime),e=b._playedtime/b.em.totaltime(),e>1&&(e=1),b.pb.pos(e),d===a?b.pause():void 0},100),this._playedtime<=0&&this.em.run(),this.sound.resumeAll()))},a.prototype.pause=function(){this._playing&&(this._playing=!1,clearInterval(this._timer),this._timer=0,this.pb.pause(),this.sound.pauseAll())},a.prototype.finish=function(){this._finished||(this._timer&&(clearInterval(this._timer),this._timer=0),this._playing=!1,this._finished=!0,this.pb.finish(),"dev"!==GG.env&&moTool.postAjax({url:"/gekijou/addplaytimes",value:{_id:this._id},callBack:function(a){},showLoad:!1,success:!1,error:!1,json:!1}))},a.prototype.run=function(){var a;a=this,setTimeout(function(){return moTool.showModalBox($("#loadmodal"),{showClose:!1}),a.preload(function(){return moTool.hideModalBox($("#loadmodal")),a.play()})},100)},a.prototype.setId=function(a){this._id=a},a.prototype.scrollToBottom=function(){this.bubble.tobottom()},a}();